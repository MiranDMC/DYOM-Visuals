{
    DYOM Visuals
    ------------
    A DYOM Add-on to add custom shaders and special effects to DYOM missions and storylines
    
    Created by:
        Toriality
        Miran
        
    Special thanks to:
        Dust Rathard
    
    Current version:
        v1.0.0
        
    Date of release (current version):
        <...>
    
    Date of release (first version):
        <...>
        
    Date of development start:
        March 23, 2023
    
    Useful links:
        <...>    
}

{$CLEO .cs}
{$USE ini}
{$NOSOURCE} // do not make script bigger


const
    hShader = 10@
    forceAiming = 11@
    forceWalking = 12@
    forceBumper = 13@
    forceCinematic = 14@
    previewMode = 15@
    lastSelected = 16@
    wasOnMission = 17@
end

var
    hShader: shader
    forceAiming: int
    forceWalking: int
    forceBumper: int
    forceCinematic: int
    previewMode: int
    lastSelected: int
    wasOnMission: int
end

script_name "DVISUALS"

{$INCLUDE shaderApi}
{$INCLUDE DYOM_Addon_Base.txt}
{$INCLUDE DYOM_Visuals_Config.txt}
{$INCLUDE DYOM_Visuals_Shaders.txt} 
{$INCLUDE DYOM_Visuals_Effects.txt}


:DYOM_INIT
    previewMode = -1 // force update first time
    lastSelected = 0
    wasOnMission = 0
    
    SHADERS_INIT()
    cleo_call @SHADERS_CONFIG_UPDATE_PARAMS 2 hShader -2 // set default parameters
    cleo_call @EFFECTS_CONFIG_UPDATE_PARAMS 1 -1 // reset defaults
return                      
 
     
:DYOM_MISSION_STARTED
    // Force shaders to load mission's first objective shaders when starting the mission,
    // avoiding preview mode to keep the editor's selected objective shaders
    cleo_call @SHADERS_CONFIG_UPDATE_PARAMS 2 hShader 1 // Objective ID 1
    wasOnMission = 1
    TimerA = 0 // mission time
return


:DYOM_MISSION_ENDED
return


:DYOM_OBJECTIVE_STARTED
    TimerB = 0 // objective time
    
    0@ += 1 // 1-based objective index
    cleo_call @SHADERS_CONFIG_UPDATE_PARAMS 2 hShader 0@ // current objective
    cleo_call @EFFECTS_CONFIG_UPDATE_PARAMS 1 0@ // current objective
    // TODO: update effects
return


:DYOM_OBJECTIVE_ENDED
return


:DYOM_RUN
    SHADERS_EDITOR_UPDATE() // handle keys etc.
    cleo_call @SHADERS_CONSTANTS_UPDATE args 0
    cleo_call @SHADERS_DRAW args 1 hShader 
return


:DYOM_MISSION_RUN
    //FORCE_AIMING()
    //FORCE_WALKING()
    //FORCE_BUMPER()
return


:SHADERS_EDITOR_UPDATE
    0@ = false // update needed

    if
        $ONMISSION == 0 // editor mode
    then
        // selected objective changed    
        if and 
            previewMode == true
            87D6: lastSelected <> $15617
        then
            008B: lastSelected = $15617
            0@ = true // update needed
        end
        
        // Should reset shaders after mission ends
        if
            wasOnMission == 1
        then
            wasOnMission = 0
            0@ = true // update needed
        end
        
        // toggle objective shaders preview key
        if or
            is_key_pressed 0x7A // F11
            previewMode == -1 // first time
        then
            while is_key_pressed 0x7A // wait for key release
                wait 0
            end
            
            if
                previewMode == false
            then
                previewMode = true
                0ACE: show_formatted_text_box "Objective effects: ~g~~h~ON~s~"
            else
                previewMode = false
                0ACE: show_formatted_text_box "Objective effects: ~r~~h~OFF~s~"  
            end
            
            0@ = true // update needed
        end
        
        // reload shaders key
        if
            is_key_pressed 0x7B // F12
        then
            while is_key_pressed 0x7B // wait for key release
                wait 0
            end
            
            0@ = true // update needed
        end
    end
    
    
    if 
        0@ == true // update needed
    then        
        if 
            previewMode == true
        then
            if
                cleo_call @CONFIG_EXISTS args 0
            then
                0085: 0@ = lastSelected // editor selected objective
                0AD1: show_formatted_text_highpriority "~g~~h~OK:~s~ Loaded shaders for Objective %d" time 3000 0@
            else
                0@ = -2 // restore defaults
                cleo_call @CONFIG_GET_FILEPATH args 0 result 1@ 2@ 3@ 3@
                0AD1: show_formatted_text_highpriority "~r~~h~ERROR:~s~ Visuals file for this mission not found!~n~Please create %s" time 10000 1@v
            end
        else
            set_current_directory 0 // game root
            if
                does_file_exist "cleo/dyom_shaders/editor.ini"
            then
                0@ = -1 // use editor.ini
                0AD1: show_formatted_text_highpriority "~g~~h~OK:~s~ Loaded shaders from editor.ini" time 3000
            else
                0@ = -2 // restore defaults
                0AD1: show_formatted_text_highpriority "~r~~h~ERROR:~s~ File cleo\dyom_shaders\editor.ini not found!" time 10000    
            end
        end
                    
        cleo_call @SHADERS_CONFIG_UPDATE_PARAMS 2 hShader 0@
        cleo_call @EFFECTS_CONFIG_UPDATE_PARAMS 1 -1 // reset effects
    end
return




/*:FORCE_AIMING
    if
        forceAiming == 1
    then
    0ACE: show_formatted_text_box "This is %.4X opcode" 0x0ACE
    
        cleo_call @FORCE_KEYPRESS 1 args 12     
    end
    return
    
    :FORCE_WALKING
    if
        forceWalking == 1
    then
        cleo_call @FORCE_KEYPRESS 1 args 42
    end
return


:FORCE_BUMPER
    if
        forceBumper == 1
    then
        09AD: set_vehicle_camera_mode 0
    end
return


:APPLY_EFFECTS 
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'speed'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'fov'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'forceCinematic'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'forceBumper'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'forceWalking'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'forceAiming'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'drunkenness'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'darkness'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'fadeout'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'fadein'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'shake'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'siteorkcet'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'radar'
    cleo_call @EFFECT_READ_CONFIG_PARAM args 1 'hud'
return


:RESET_EFFECTS
    015D: set_gamespeed 1.0
    0931: lock_camera_zoom 0
    forceBumper = 0
    093D: lock_camera_on_cinematic_view 0
    forceCinematic = 0
    forceWalking = 0
    06AF: set_player $PLAYER_CHAR sprint_mode 0 // 1 to disable 0 to enable sprint
    0901: enable_player $PLAYER_CHAR jump_key 1
    082A: set_player $PLAYER_CHAR able_to_use_crouch_button 1
    forceAiming = 0
    0992: set_player $PLAYER_CHAR weapons_scrollable 1
    052C: set_player $PLAYER_CHAR drunk_visuals 0
    0924: enable_screen_darkness 0 with_value -1
    016A: fade 0 time 0
    016A: fade 1 time 0
    0003: shake_camera 0
    09A3: show_siterocket_on_bumper_camera 0
    0581: enable_radar 1
    0826: enable_hud 1
    09B9: show_entered_car_name 1
    09BA: show_entered_zone_name 1
return


:FORCE_KEYPRESS
    0@ += 0xB734D0 // High Priority Controls
    0A8C: write_memory 0@ size 1 value 255 virtual_protect 0
cleo_return 0

    
// arg 0 - effect name
:EFFECT_READ_CONFIG_PARAM
    // copy param name
    read_memory 1@ = read_memory 0@ size 4 virtual_protect 0 // 4 chars
    0@ += 4
    read_memory 2@ = read_memory 0@ size 4 virtual_protect 0 // 4 chars
    0@ += 4
    read_memory 3@ = read_memory 0@ size 4 virtual_protect 0 // 4 chars
    0@ += 4
    read_memory 4@ = read_memory 0@ size 4 virtual_protect 0 // 4 chars
    
    set_current_directory 1

    
    // section name
    008B: 5@ = dyom_objective_index
    5@ += 1 // 1-based
    string_format 11@v = string_format "OBJECTIVE_%d" 5@
    if
        0AF2: 20@ = read_float_from_ini_file 7@v section 11@v key 1@v
    then
        // Apply effects
        if
            1@v == "speed"
        then
            015D: set_gamespeed 20@
        end
        
        if
            1@v == "fov"
        then
            0922: set_camera_zoom_from 20@ to 20@ timelimit 1000 smooth_transition 0
            0931: lock_camera_zoom 1
        end
        
        if
            1@v == "forceCinematic"
        then
            0092: 20@ = float 20@ to_integer
            0006: forceCinematic = 20@
            093D: lock_camera_on_cinematic_view 20@
        end
        
        if
            1@v == "forceBumper"
        then
            0092: 20@ = float 20@ to_integer
            0006: forceBumper = 20@
        end
        
        if
            1@v == "forceWalking"
        then 
            0092: 20@ = float 20@ to_integer
            0006: forceWalking = 20@
            06AF: set_player $PLAYER_CHAR sprint_mode 20@ // 1 to disable 0 to enable sprint
            20@ = 1 - 20@ // if 8@ = 1 then 0, if 8@ = 0, then 1
            0901: enable_player $PLAYER_CHAR jump_key 20@
            082A: set_player $PLAYER_CHAR able_to_use_crouch_button 20@
        end
        
        if
            1@v == "forceAiming"
        then
            0092: 20@ = float 20@ to_integer
            0085: forceAiming = 20@ // (int)
            20@ = 1 - 20@ // if 8@ = 1 then 0, if 8@ = 0, then 1
            0992: set_player $PLAYER_CHAR weapons_scrollable 20@
            
        end
        
        if
            1@v == "drunkenness"
        then
            0092: 20@ = float 20@ to_integer
            052C: set_player $PLAYER_CHAR drunk_visuals 20@
        end
        
        if
            1@v == "darkness"
        then
            0092: 20@ = float 20@ to_integer
            0924: enable_screen_darkness 20@ with_value -1
        end
        
        if
            1@v == "fadeout"
        then
            0092: 20@ = float 20@ to_integer
            016A: fade 0 time 20@
        end
        
        if
            1@v == "fadein"
        then
            0092: 20@ = float 20@ to_integer
            016A: fade 1 time 20@
        end
        
        if
            1@v == "shake"
        then
            0092: 20@ = float 20@ to_integer
            0003: shake_camera 20@
        end
        
        if
            1@v == "siterocket"
        then
            0092: 20@ = float 20@ to_integer
            09A3: show_siterocket_on_bumper_camera 20@
        end
        
        if
            1@v == "radar"
        then
            0092: 20@ = float 20@ to_integer
            0581: enable_radar 20@
        end
        
        if
            1@v == "hud"
        then
            0092: 20@ = float 20@ to_integer
            0826: enable_hud 20@
            09B9: show_entered_car_name 20@
            09BA: show_entered_zone_name 20@
        end
    end
cleo_return 0*/
